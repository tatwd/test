<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Writing</title>
    <link
      href="https://fonts.googleapis.com/css?family=Noto+Serif+SC"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./main.css" />
    <style>
      .container {
        padding-top: 25px;
        padding-bottom: 25px;
      }
      .poetry-link {
        font-size: 18px;
        color: #234;
      }
      .badge--light {
        color: #456;
      }
    </style>
  </head>
  <body>
    <div class="container" id="poetries">
      <div class="bouncing-loader">
        <span class="bouncing-loader--item"></span>
        <span class="bouncing-loader--item"></span>
        <span class="bouncing-loader--item"></span>
      </div>
    </div>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <script>
      $(function() {
        var $titleLinks = $('.title-links');
        var $poetries = $('#poetries');
        var renderHTML = function (year, data) {
          var s = '';
          $.each(data, function(index, item) {
            s += `
<p><a
  class="poetry-link text-decoration--none"
  title="写于${item.created_at}"
  href="./poetry.html?key=${encodeURI(index)}"
>${item.title}</a> <small class='badge--light'>${item.type === 1 ? '[旧体]' : ''}</small>
</p>`;
          });
          return `
<section>
  <p><small><b>${year}</b></small></p>
  <div class="title-links">${s || '无'}</div>
</section>`;
        };
        var render = function($el, data) {
          data = reducePoetries(data);
          var s = '';
          for (var year in data) {
            if (!data.hasOwnProperty(year)) continue;
            s = renderHTML(year, data[year]) + s;
          }
          $el.html(s || '无');
        };
        var reducePoetries = function (poetries) {
          return poetries.reduce(function (ret, cur) {
            var key = new Date(cur.created_at).getFullYear();
            if (!ret[key]) ret[key] = [];
            ret[key].push(cur);
            return ret;
          }, {});
        };
        var fetchPoetries = function (cb) {
          $.get('./poetries.json')
            .done(function(data, type, xhr) {
              cb && cb(data, xhr);
            })
            .fail(function(res) {
              console.log(res);
              $poetries.html('获取数据失败，可以打开控制台查询错误信息！');
            });
        };

        window.setTimeout(function() {
          var data = JSON.parse(localStorage.getItem('poetries')) || [];
          render($poetries, data);
          fetchPoetries(function(data, xhr) {
            var lastModified = localStorage.getItem('last_modified');
            var nowLastModified = new Date(
              xhr.getResponseHeader('last-modified')
            )
              .getTime()
              .toString();
            console.log(lastModified, nowLastModified);
            if (!lastModified || lastModified != nowLastModified) {
              localStorage.setItem('last_modified', nowLastModified);
              localStorage.setItem('poetries', JSON.stringify(data));
              render($poetries, data);
            }
          });
        }, 500);
      });
    </script>
  </body>
</html>
